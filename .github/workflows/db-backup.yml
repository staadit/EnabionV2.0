name: db backup

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  backup-db:
    runs-on: ubuntu-latest
    env:
      HOST: ${{ secrets.VPS_HOST }}
      USER: ${{ secrets.VPS_USER }}
      PORT: ${{ secrets.VPS_PORT || '22' }}
    steps:
      - name: Checkout repo (dev)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev

      - name: Prepare backup-dev branch
        run: |
          git fetch origin backup-dev || true
          if git show-ref --quiet refs/remotes/origin/backup-dev; then
            git checkout backup-dev
            git merge origin/dev --no-edit
          else
            git checkout -b backup-dev
          fi

      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts

      - name: Dump DB from VPS (prod stack)
        run: |
          ts=$(date -u +"%Y%m%d-%H%M%S")
          ssh -p "$PORT" "${USER}@${HOST}" \
            "cd /srv/enabion/prod/repo && docker compose -f infra/docker-compose.prod.yml exec -T db pg_dump -U enabion enabion_prod" \
            > "db-backup-${ts}.sql"
          gzip "db-backup-${ts}.sql"
          echo "TS=$ts" >> $GITHUB_ENV
          echo "BACKUP_FILE=db-backup-${ts}.sql.gz" >> $GITHUB_ENV

      - name: Commit backup into backup-dev branch
        run: |
          mkdir -p db-backups
          mv "$BACKUP_FILE" db-backups/
          git add db-backups/
          git commit -m "db-backup: dev $TS" || echo "Nothing to commit"

      - name: Push backup-dev
        run: git push origin backup-dev
