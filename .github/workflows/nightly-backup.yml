name: branch-backups

permissions:
  contents: write

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

jobs:
  backup-main:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Use GITHUB_TOKEN for push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git

      - name: Sync main into backup branch
        run: |
          git fetch origin backup
          git checkout backup
          git merge origin/main --no-edit
          git push origin backup

      - name: Tag backup-main and prune older than 90 days
        run: |
          ts="backup-main-$(date -u +"%Y%m%d-%H%M%S")"
          git tag "$ts"
          git push origin "$ts"
          cutoff=$(date -u -d '90 days ago' +%s)
          for tag in $(git for-each-ref --format='%(refname:short) %(creatordate:unix)' refs/tags/backup-main-* | sort -k2 | awk -v c=$cutoff '$2 < c {print $1}'); do
            git tag -d "$tag"
            git push origin --delete "$tag"
          done

  backup-dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev

      - name: Detect changes on dev in last 24h
        id: detect_changes
        run: |
          git fetch origin dev
          if git log origin/dev --since='1 day ago' --oneline | grep -q .; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip backup (no changes)
        if: steps.detect_changes.outputs.changed == 'false'
        run: echo "No changes on dev in last 24h; skipping backup."

      - name: Configure git
        if: steps.detect_changes.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

      - name: Use GITHUB_TOKEN for push
        if: steps.detect_changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git

      - name: Create zip from dev HEAD
        if: steps.detect_changes.outputs.changed == 'true'
        run: |
          ts="$(date -u +"%Y%m%d-%H%M%S")"
          git archive --format=zip -o "/tmp/dev-backup-${ts}.zip" HEAD
          echo "ZIP_PATH=/tmp/dev-backup-${ts}.zip" >> $GITHUB_ENV
          echo "TS=${ts}" >> $GITHUB_ENV

      - name: Sync dev into backup-dev branch and store zip
        if: steps.detect_changes.outputs.changed == 'true'
        run: |
          git fetch origin backup-dev || true
          git checkout backup-dev || git checkout --orphan backup-dev
          mkdir -p backup-dev
          cp "${ZIP_PATH}" "backup-dev/dev-backup-${TS}.zip"
          find backup-dev -maxdepth 1 -name 'dev-backup-*.zip' -print | sort > /tmp/dev-backups.txt
          count=$(wc -l < /tmp/dev-backups.txt | tr -d ' ')
          if [ "$count" -gt 90 ]; then
            head -n $(($count - 90)) /tmp/dev-backups.txt | xargs -r rm --
          fi
          git add backup-dev/
          git commit -m "backup(dev): dev-backup-${TS}" || echo "Nothing to commit"
          git push origin backup-dev

      - name: Tag backup-dev and prune older than 90 days
        if: steps.detect_changes.outputs.changed == 'true'
        run: |
          ts="backup-dev-$(date -u +"%Y%m%d-%H%M%S")"
          git tag "$ts"
          git push origin "$ts"
          cutoff=$(date -u -d '90 days ago' +%s)
          for tag in $(git for-each-ref --format='%(refname:short) %(creatordate:unix)' refs/tags/backup-dev-* | sort -k2 | awk -v c=$cutoff '$2 < c {print $1}'); do
            git tag -d "$tag"
            git push origin --delete "$tag"
          done
